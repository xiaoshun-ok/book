"use strict";var classCallCheck=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),slicedToArray=function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,n){var r=[],t=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(t=(a=c.next()).done)&&(r.push(a.value),!n||r.length!==n);t=!0);}catch(e){o=!0,i=e}finally{try{!t&&c.return&&c.return()}finally{if(o)throw i}}return r}(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")},Dep=function(){function e(){classCallCheck(this,e),this.deps=[]}return createClass(e,[{key:"add",value:function(e){this.deps.push(e)}},{key:"notify",value:function(){for(var e=0;e<this.deps.length;e++)this.deps[e]();this.deps.length=0}}]),e}(),isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},DB=function(){function t(e){var n=e.dbName,r=e.version;classCallCheck(this,t),this.dbName=n,this.version=r,this.db=null,this.idb=null,this.table=[],this._status=!1,this._dep_=new Dep}return createClass(t,[{key:"open",value:function(e){var r=this,n=function(){},t=function(){};if(e&&(n=e.success?e.success:n,t=e.error?e.error:t),0!=this.table.length||this._status)if("function"==typeof n){var o=indexedDB.open(this.dbName,this.version);o.onerror=function(e){t(e.currentTarget.error.message)},o.onsuccess=function(e){r.db=e.target.result,r._dep_.notify(),n(r.db)},o.onupgradeneeded=function(e){r.idb=e.target.result;for(var n=0;n<r.table.length;n++)r.__create_table(r.idb,r.table[n])}}else t("open中success必须是一个function类型");else t("打开前要先用add_table添加表")}},{key:"close_db",value:function(){var e=this;this.__action(function(){e.db.close()})}},{key:"delete_db",value:function(){indexedDB.deleteDatabase(name)}},{key:"clear_table",value:function(e){var n=this;this.__action(function(){return n.__create_transaction(e,"readwrite").clear()})}},{key:"add_table",value:function(e){var n=0<arguments.length&&void 0!==e?e:{};this._status=!1,this.table.push(n)}},{key:"query",value:function(o,i){var a=this;return new Promise(function(n,t){"function"!=typeof i&&(i=function(){return!0});a.__action(function(){var r=[],e=a.__create_transaction(o,"readonly").openCursor();e.onsuccess=function(e){return a.__cursor_success(e,{condition:i,handler:function(e){var n=e.currentValue;return r.push(n)},over:function(){return n(r)}})},e.onerror=function(e){return t("query,in openCursor onerror ")}})})}},{key:"insert",value:function(r,t){var o=this;return new Promise(function(e,n){isArray(t)||isObject(t)||n("in insert，data type is Object or Array"),o.__action(function(){var n=o.__create_transaction(r,"readwrite");isArray(t)?t.forEach(function(e){return n.put(e)}):n.put(t),e(t)})})}},{key:"delete",value:function(i,a){var c=this;return new Promise(function(n,r){var e=void 0,o=void 0;e="function"!=typeof a?function(){(o=c.__create_transaction(i,"readwrite").delete(a)).onsuccess=function(){return n()},o.onerror=function(){return r()}}:function(){var t=[];(o=c.__create_transaction(i,"readwrite").openCursor()).onsuccess=function(e){return c.__cursor_success(e,{condition:a,handler:function(e){var n=e.currentValue,r=e.cursor;t.push(n),r.delete()},over:function(){0==t.length?r("in delete ,数据库中没有任何符合condition的元素"):n(t)}})},o.onerror=function(e){return r("delete,in openCursor onerror ")}},c.__action(e)})}},{key:"update",value:function(a,c,u){var s=this;return new Promise(function(o,i){if("function"!=typeof u)i("in update,handle必须是一个function类型");else{s.__action(function(){if("function"!=typeof c){var r=s.__create_transaction(a,"readwrite"),e=r.get(c);e.onsuccess=function(e){var n=e.target.result;u(n),r.put(n),o(n)},e.onerror=function(e){return i("delete,in openCursor onerror ")}}else{var t=[],n=s.__create_transaction(a,"readwrite").openCursor();n.onsuccess=function(e){return s.__cursor_success(e,{condition:c,handler:function(e){var n=e.currentValue,r=e.cursor;u(n),t.push(n),r.update(n)},over:function(){0==t.length?o(null):o(t)}})},n.onerror=function(e){return i("delete,in openCursor onerror ")}}})}})}},{key:"find",value:function(c,u){var s=this;return new Promise(function(i,a){s.__action(function(){var e=void 0,n=void 0,r=void 0;if(isArray(u)){var t=slicedToArray(u,2);n=t[0],r=t[1],e=s.__create_transaction(c,"readonly").index(n).getAll(r)}else if(isObject(u)){for(var o in u)r=u[n=o];e=r?s.__create_transaction(c,"readonly").index(n).getAll(r):s.__create_transaction(c,"readonly").index(n).getAll()}else e=s.__create_transaction(c,"readonly").getAll(u);e.onsuccess=function(e){var n=e.target.result||null;i(n)},e.onerror=function(e){return a("find,in openCursor onerror ")}})})}},{key:"__cursor_success",value:function(e,n){var r=n.condition,t=n.handler,o=n.over,i=e.target.result;if(i){var a=i.value;r(a)&&t({cursor:i,currentValue:a}),i.continue()}else o()}},{key:"__create_transaction",value:function(e,n){var r=1<arguments.length&&void 0!==n?n:"readwrite";if(!e||!r)throw new Error("in __create_transaction,tableName and mode is required");return this.db.transaction(e,r).objectStore(e)}},{key:"__action",value:function(e){function n(){e()}this.db?n():this._dep_.add(n)}},{key:"__create_table",value:function(e,n){var r=n.tableName,t=n.option,o=n.indexs,i=void 0===o?[]:o;if(!e.objectStoreNames.contains(r)){var a=e.createObjectStore(r,t),c=!0,u=!1,s=void 0;try{for(var l,f=i[Symbol.iterator]();!(c=(l=f.next()).done);c=!0){var d=l.value;this.__create_index(a,d)}}catch(e){u=!0,s=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw s}}}}},{key:"__create_index",value:function(e,n){var r=n.key,t=n.option;e.createIndex(r,r,t)}}]),t}();function Idb(e){var n=e.dbName,r=e.version,t=void 0===r?1:r,o=e.tables,i=void 0===o?[]:o,a=new DB({dbName:n,version:t}),c=!0,u=!1,s=void 0;try{for(var l,f=i[Symbol.iterator]();!(c=(l=f.next()).done);c=!0){var d=l.value;a.add_table(d)}}catch(e){u=!0,s=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw s}}return new Promise(function(e,n){a.open({success:function(){e(a)},error:function(e){n(e)}})})}module.exports=Idb;
